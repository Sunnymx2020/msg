<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Temp Chat (App Prototype)</title>
  <!-- Firebase SDK (v10 compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>
  <!-- Crypto‑JS for simple AES end‑to‑end encryption -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  <!-- Minimal inline styling (you can redesign later) -->
  <style>
    body {font-family: system-ui, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh;}
    #chat {flex: 1; overflow-y: auto; padding: 12px; background:#f5f5f5;}
    #controls {display: flex; border-top: 1px solid #ddd;}
    #msgInput {flex: 1; padding: 8px; font-size: 15px; border: none; outline: none;}
    #sendBtn {padding: 0 16px; font-size: 15px; border: none; cursor: pointer; background:#2196f3; color:#fff;}
  </style>
</head>
<body>
  <div id="chat"><!-- Messages will stream here --></div>
  <div id="controls">
    <input id="msgInput" autocomplete="off" placeholder="Message" />
    <button id="sendBtn">Send</button>
  </div>

  <script>
    // 1⃣  Replace with **your own** Firebase config (Project Settings ▸ Web App).
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // 2⃣  Shared secret for E2E encryption (hard‑coded demo) — generate / negotiate per room in a real app.
    const SECRET_KEY = "mySuperSecretKey"; // ⚠️ Change this & never commit real keys!

    // 3⃣  Room ID — could be dynamic (URL param etc.)
    const ROOM_ID = "defaultRoom";

    // --- Firebase init ---
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // DOM refs
    const chatEl    = document.getElementById("chat");
    const inputEl   = document.getElementById("msgInput");
    const sendBtnEl = document.getElementById("sendBtn");

    // Append message to UI
    function appendMessage(sender, text) {
      const div = document.createElement("div");
      div.textContent = `${sender}: ${text}`;
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    // Send message
    sendBtnEl.addEventListener("click", () => {
      const plain = inputEl.value.trim();
      if (!plain) return;
      const cipher = CryptoJS.AES.encrypt(plain, SECRET_KEY).toString();
      db.collection("rooms").doc(ROOM_ID).collection("messages").add({
        text: cipher,
        ts: firebase.firestore.FieldValue.serverTimestamp()
      });
      inputEl.value = "";
    });

    // Listen for new messages (ordered by timestamp)
    db.collection("rooms").doc(ROOM_ID).collection("messages")
      .orderBy("ts")
      .onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
          if (change.type === "added") {
            const { text } = change.doc.data();
            // Decrypt with the shared secret
            const plain = CryptoJS.AES.decrypt(text, SECRET_KEY).toString(CryptoJS.enc.Utf8);
            const isLocal = change.doc.metadata.hasPendingWrites; // true if this tab sent it
            appendMessage(isLocal ? "You" : "Peer", plain);
          }
        });
      });
  </script>
</body>
</html>
