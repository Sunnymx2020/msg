<!DOCTYPE html>
<html>
<head>
  <title>Firebase Chat â€¢ Onboard â†’ Chat</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0">
  <!-- Firebase v8 SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    body{font-family:sans-serif;margin:0;padding:16px;background:#f5f5f5;}
    h2,h3{margin:4px 0 12px}
    input,select,button{padding:8px;font-size:15px;border:1px solid #ccc;border-radius:4px}
    button{cursor:pointer}
    #chatBox{height:55vh;overflow-y:auto;background:#fff;margin:8px 0;padding:8px;border:1px solid #ccc;border-radius:6px}
    .msg{margin:6px 0;padding:6px 8px;border-radius:6px;max-width:75%}
    .me{background:#c8e6c9;margin-left:auto}
    .them{background:#e1f5fe}
    #onboarding,#chatScreen{display:none}
  </style>
</head>
<body>

<!-- â”€â”€ Onboarding Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="onboarding">
  <h2>Welcome ðŸ‘‹</h2>
  <p>Pick a unique <b>username</b> and optional displayâ€‘picture URL.</p>
  <input id="obName" placeholder="Username (e.g. suzzy)" style="width:100%;margin-bottom:8px"><br>
  <input id="obDp"   placeholder="DP image URL (optional)" style="width:100%;margin-bottom:12px"><br>
  <button onclick="completeOnboarding()">Save &amp; Continue âžœ</button>
</div>

<!-- â”€â”€ Chat Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="chatScreen">
  <h3 id="meHeader"></h3>

  <label for="receiverSel">Chat with:</label>
  <select id="receiverSel" onchange="chooseReceiver()" style="margin-left:6px"></select>

  <div id="chatBox"></div>

  <input id="msgInput" placeholder="Type a messageâ€¦" style="width:70%">
  <button onclick="sendMsg()">Send</button>
</div>

<script>
/* â”€â”€ 1. Firebase CONFIG with your keys â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var firebaseConfig = {
  apiKey:            "AIzaSyBPF1VE82Y3VkZe6IibjqKxBC-XHjM_Wco",
  authDomain:        "chat-2024-ff149.firebaseapp.com",
  databaseURL:       "https://chat-2024-ff149-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:         "chat-2024-ff149",
  storageBucket:     "chat-2024-ff149.appspot.com",
  messagingSenderId: "146349109253",
  appId:             "1:146349109253:android:e593afbf0584762519ac6c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* â”€â”€ 2. Simple state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let me   = null;   // my username
let meDp = "";     // my dp url
let them = null;   // current receiver
let chatListenerSent     = null;
let chatListenerReceived = null;

/* â”€â”€ 3. Boot: show onboarding OR chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
window.addEventListener('load', () => {
  const stored = JSON.parse(localStorage.getItem("chatUser"));
  if (stored && stored.name) {
    me   = stored.name;
    meDp = stored.dp || "";
    showChatScreen();
  } else {
    document.getElementById("onboarding").style.display = "block";
  }
});

/* â”€â”€ 4. Onboarding save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function completeOnboarding(){
  const name = document.getElementById("obName").value.trim();
  const dp   = document.getElementById("obDp").value.trim();
  if(!name){ alert("Username required"); return; }

  // save to /users/{name}
  db.ref(`users/${name}`).set({
    username: name,
    dp: dp,
    createdAt: Date.now()
  }).then(()=>{
    localStorage.setItem("chatUser", JSON.stringify({name, dp}));
    me   = name;
    meDp = dp;
    showChatScreen();
  }).catch(e=>alert("Error: "+e.message));
}

/* â”€â”€ 5. Show chat UI, load users list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showChatScreen(){
  document.getElementById("onboarding").style.display = "none";
  document.getElementById("chatScreen").style.display = "block";
  document.getElementById("meHeader").innerHTML = `Logged in as <b>${me}</b>`;
  loadUserList();
}

/* â”€â”€ 6. Load other users into dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function loadUserList(){
  const sel = document.getElementById("receiverSel");
  sel.innerHTML = "<option value=''>-- choose user --</option>";

  db.ref("users").once("value", snap=>{
    snap.forEach(child=>{
      const u = child.key;
      if(u !== me){
        const opt = document.createElement("option");
        opt.value = u;
        opt.textContent = u;
        sel.appendChild(opt);
      }
    });
  });
}

/* â”€â”€ 7. Choose receiver, attach listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function chooseReceiver(){
  const sel = document.getElementById("receiverSel");
  if(!sel.value){ clearChat(); return; }
  them = sel.value;
  clearChat();
  listenToChat();
}

/* â”€â”€ 8. Listen to BOTH chat paths â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function listenToChat(){
  const box = document.getElementById("chatBox");

  // detach old listeners if they exist
  if(chatListenerSent)     chatListenerSent.off();
  if(chatListenerReceived) chatListenerReceived.off();

  // my outbound messages
  chatListenerSent = db.ref(`chat/${me}/${them}`);
  chatListenerSent.on("child_added", snap=>{
    renderMsg(snap.val(), true);
  });

  // messages they sent to me
  chatListenerReceived = db.ref(`chat/${them}/${me}`);
  chatListenerReceived.on("child_added", snap=>{
    renderMsg(snap.val(), false);
  });
}

/* â”€â”€ 9. Send a message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function sendMsg(){
  if(!them){ alert("Select a user first"); return; }
  const txt = document.getElementById("msgInput").value.trim();
  if(!txt) return;

  db.ref(`chat/${me}/${them}`).push({
    sender:   me,
    receiver: them,
    dp:       meDp,
    id:       me,
    key:      txt,
    time:     Date.now()
  });
  document.getElementById("msgInput").value = "";
}

/* â”€â”€ 10. Render incoming/outgoing message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderMsg(data, isMe){
  const div = document.createElement("div");
  div.className = `msg ${isMe? "me":"them"}`;
  div.innerHTML  = `<b>${data.sender}</b>: ${data.key}`;
  document.getElementById("chatBox").appendChild(div);
  // autoâ€‘scroll
  const box = document.getElementById("chatBox");
  box.scrollTop = box.scrollHeight;
}

/* â”€â”€ 11. Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function clearChat(){
  document.getElementById("chatBox").innerHTML = "";
}

</script>
</body>
</html>
