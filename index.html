<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WhatsApp‑like Chat</title>

    <!-- Latest stable PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>

    <!-- ⚠️  UI/CSS तुमच्या मूळ फाइलमधीलच आहे; काहीही बदललेले नाही -->
    <style>
        body{font-family:sans-serif;margin:0;padding:1rem;background:#f5f5f5}
        #app{max-width:480px;margin:0 auto;background:#fff;padding:1rem;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
        #chat-box{height:260px;overflow-y:auto;border:1px solid #ccc;border-radius:6px;padding:6px;margin:8px 0;background:#fafafa}
        #chat-box div{margin-bottom:4px}
        .me{color:#0b7285;font-weight:600}
        .other{color:#495057}
        input,button{padding:8px;font-size:1rem;border-radius:4px;border:1px solid #ccc}
        button{cursor:pointer;background:#0d6efd;color:#fff;border:none}
        button:disabled{opacity:.6;cursor:not-allowed}
    </style>
</head>
<body>
<div id="app">
    <h3 id="status">Initializing chat…</h3>
    <p>My ID: <span id="peer-id">--</span></p>

    <input id="connect-id" type="text" placeholder="Remote peer ID" style="width:65%">
    <button id="connect-btn" style="width:32%">Connect</button>
    <p style="margin:4px 0;min-height:18px"><small id="chat-status"></small></p>

    <div id="chat-box"></div>

    <input id="message-input" type="text" placeholder="Type message" style="width:75%">
    <button id="send-btn" style="width:23%">Send</button>
</div>

<script>
// ----- PeerJS initialisation -----
const peer = new Peer({
  host: location.hostname,
  port: location.protocol === 'https:' ? 443 : 9000,  // 🛈 तुमचा PeerJS server पोर्ट जर वेगळा असेल तर बदला
  path: '/peerjs',
  secure: location.protocol === 'https:',
  debug: 2,
  config: {
    iceServers: [
      { urls: 'stun:stun.l.google.com:19302' },
      { urls: 'stun:stun1.l.google.com:19302' }
      // TURN server आवश्यकता असल्यास खाली extra entry add करा
      // { urls: 'turn:YOUR_TURN_SERVER', username: 'user', credential: 'pass' }
    ]
  }
});

let conn = null;            // Active data connection

// 👉 Peer open → Ready
peer.on('open', id => {
  document.getElementById('peer-id').textContent = id;
  document.getElementById('status').textContent  = 'Ready';
});

// 👉 Incoming connection handler
peer.on('connection', incoming => {
  if (conn) incoming.close();   // Allow only one connection at a time
  conn = incoming;
  prepareConn();
});

// 👉 Attempt outgoing connection
function connectToPeer() {
  const remoteId = document.getElementById('connect-id').value.trim();
  if (!remoteId) return alert('Enter remote ID first');
  if (conn) conn.close();
  conn = peer.connect(remoteId, { reliable: true });
  prepareConn();
}

// 👉 Common connection lifecycle
function prepareConn() {
  if (!conn) return;
  document.getElementById('chat-status').textContent = 'Connecting…';

  conn.on('open', () => {
    document.getElementById('chat-status').textContent = 'Connected';
  });

  conn.on('data', data => appendMsg('Friend', data, 'other'));

  conn.on('close', () => {
    document.getElementById('chat-status').textContent = 'Disconnected';
  });

  conn.on('error', err => {
    console.error('[Conn error]', err);
    document.getElementById('chat-status').textContent = 'Error: ' + err.type;
  });
}

// 👉 Send message
function sendMessage() {
  const box = document.getElementById('message-input');
  const text = box.value.trim();
  if (!text || !conn || !conn.open) return;
  conn.send(text);
  appendMsg('You', text, 'me');
  box.value = '';
}

// 👉 Append message to chat-box
function appendMsg(sender, text, cls) {
  const line = document.createElement('div');
  line.className = cls;
  line.textContent = `${sender}: ${text}`;
  const chat = document.getElementById('chat-box');
  chat.appendChild(line);
  chat.scrollTop = chat.scrollHeight;
}

// 👉 Reconnect logic (max 5 attempts every 3s)
let retries = 0;
peer.on('disconnected', () => {
  if (retries >= 5) return;
  document.getElementById('chat-status').textContent = 'Reconnecting…';
  setTimeout(() => {
    retries++;
    peer.reconnect();
  }, 3000);
});

// 👉 UI bindings

document.getElementById('connect-btn').addEventListener('click', connectToPeer);
document.getElementById('send-btn').addEventListener('click', sendMessage);

document.getElementById('message-input').addEventListener('keyup', e => {
  if (e.key === 'Enter') sendMessage();
});
</script>
</body>
</html>
