<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp-like Chat</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        /* [Keep all your existing CSS styles] */
    </style>
</head>
<body>
    <!-- [Keep all your existing HTML structure] -->

    <script>
        // Improved connection handling
        let peer;
        let conn;
        let retryCount = 0;
        const maxRetries = 3;

        // 1. Generate more reliable user ID
        function generateUserId() {
            let userId = localStorage.getItem('peerChatUserId');
            if (!userId) {
                userId = 'user-' + Math.random().toString(36).substring(2, 10) + 
                         '-' + Date.now().toString(36);
                localStorage.setItem('peerChatUserId', userId);
            }
            return userId;
        }

        // 2. Initialize PeerJS with error handling
        function initializePeer() {
            const userId = generateUserId();
            document.getElementById('my-id').textContent = userId;
            
            // Create Peer with debug logging
            peer = new Peer(userId, {
                debug: 3, // Enable verbose logging
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:global.stun.twilio.com:3478?transport=udp' }
                    ]
                }
            });

            peer.on('open', (id) => {
                console.log('PeerJS connected with ID:', id);
                document.getElementById('my-id').textContent = id;
                updateConnectionStatus(true, 'Ready to connect');
                retryCount = 0; // Reset retry counter on success
            });

            peer.on('error', (err) => {
                console.error('PeerJS error:', err);
                
                // Handle specific error cases
                if (err.type === 'unavailable-id') {
                    // Generate new ID if current one is unavailable
                    localStorage.removeItem('peerChatUserId');
                    initializePeer();
                } else if (retryCount < maxRetries) {
                    // Retry connection
                    retryCount++;
                    console.log(`Retrying connection (attempt ${retryCount})...`);
                    setTimeout(initializePeer, 2000 * retryCount);
                } else {
                    updateConnectionStatus(false, 'Connection failed');
                }
            });

            peer.on('connection', (connection) => {
                console.log('Incoming connection from:', connection.peer);
                handleNewConnection(connection);
            });
        }

        // 3. Improved connection handling
        function handleNewConnection(connection) {
            if (conn) {
                console.log('Already connected, rejecting new connection');
                connection.close();
                return;
            }

            conn = connection;
            
            conn.on('open', () => {
                console.log('Connection established with:', conn.peer);
                updateConnectionStatus(true, `Connected to ${conn.peer.substring(0, 8)}...`);
                addSystemMessage(`Connected to ${conn.peer}`);
                setupDataChannel();
            });

            conn.on('close', () => {
                console.log('Connection closed');
                handleDisconnection();
            });

            conn.on('error', (err) => {
                console.error('Connection error:', err);
                handleDisconnection();
            });
        }

        // 4. Data channel setup
        function setupDataChannel() {
            conn.on('data', (data) => {
                try {
                    const message = JSON.parse(data);
                    addMessageToChat(message.text, false, message.sender || 'Peer', message.timestamp);
                } catch (e) {
                    console.error('Error parsing message:', e);
                }
            });
        }

        // 5. Connection status UI updates
        function updateConnectionStatus(connected, message) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('connectionStatusText');
            
            if (connected) {
                indicator.className = 'status-indicator connected';
                statusText.textContent = message || 'Connected';
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendButton').disabled = false;
            } else {
                indicator.className = 'status-indicator';
                statusText.textContent = message || 'Disconnected';
                document.getElementById('messageInput').disabled = true;
                document.getElementById('sendButton').disabled = true;
            }
        }

        // 6. Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializePeer();
            
            // Set up event listeners
            document.getElementById('sendButton').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            
            // [Keep all your other existing event listeners]
        });

        // [Keep all your other existing functions]
    </script>
</body>
</html>
