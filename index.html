<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Chat</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        .chat-container {
            height: calc(100vh - 64px);
        }
        .chat-bubble {
            max-width: 70%;
            word-wrap: break-word;
        }
        .sidebar {
            transition: transform 0.3s ease;
        }
        .dark .bg-chat-pattern {
            background-image: url('data:image/svg+xml,%3Csvg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="%232d3748" fill-opacity="0.1"%3E%3Ccircle cx="3" cy="3" r="2"/%3E%3Ccircle cx="17" cy="17" r="2"/%3E%3C/g%3E%3C/svg%3E');
        }
        .bg-chat-pattern {
            background-image: url('data:image/svg+xml,%3Csvg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="%23e2e8f0" fill-opacity="0.4"%3E%3Ccircle cx="3" cy="3" r="2"/%3E%3Ccircle cx="17" cy="17" r="2"/%3E%3C/g%3E%3C/svg%3E');
        }
        @media (max-width: 640px) {
            .sidebar {
                transform: translateX(-100%);
                position: fixed;
                z-index: 20;
                width: 75%;
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .modal-content {
                width: 90%;
            }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">
    <div class="flex flex-col h-screen">
        <!-- Header -->
        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-4 flex justify-between items-center shadow-lg">
            <div class="flex items-center space-x-3">
                <button id="toggle-sidebar" class="sm:hidden text-white">
                    <i class="fas fa-bars fa-lg"></i>
                </button>
                <h1 class="text-xl font-bold">Modern Chat</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="copy-peer-id" class="text-white hover:text-gray-200" title="Copy Your ID">
                    <i class="fas fa-copy fa-lg"></i>
                </button>
                <button id="toggle-theme" class="text-white hover:text-gray-200" title="Toggle Theme">
                    <i class="fas fa-moon fa-lg"></i>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex flex-1 overflow-hidden">
            <!-- Sidebar (Peer List) -->
            <div id="sidebar" class="sidebar sm:w-1/4 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 overflow-y-auto">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                    <button onclick="openModal()" class="p-2 text-indigo-500 dark:text-indigo-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full" title="Add Friend">
                        <i class="fas fa-user-plus fa-lg"></i>
                    </button>
                </div>
                <div id="peer-list" class="divide-y divide-gray-200 dark:divide-gray-700"></div>
            </div>

            <!-- Chat Area -->
            <div class="flex-1 flex flex-col chat-container">
                <div class="bg-white dark:bg-gray-800 p-3 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <div>
                        <span class="font-semibold" id="current-peer">No peer selected</span>
                        <div class="text-sm text-gray-500 dark:text-gray-400" id="connection-status">Disconnected</div>
                    </div>
                    <div id="peer-id-display" class="text-sm text-gray-500 dark:text-gray-400">Generating ID...</div>
                </div>
                <div id="chat-box" class="flex-1 p-4 overflow-y-auto bg-chat-pattern">
                    <!-- Messages will be added here -->
                </div>
                <div class="p-4 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 flex items-center space-x-2">
                    <input type="text" id="message-input" placeholder="Type a message..." class="flex-1 p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400">
                    <button onclick="sendMessage()" class="p-2 text-white bg-indigo-500 rounded-lg hover:bg-indigo-600">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Connect Modal -->
    <div id="connect-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-lg w-80 shadow-xl">
            <h2 class="text-lg font-semibold mb-4 flex items-center text-gray-900 dark:text-gray-100">
                <i class="fas fa-link mr-2 text-indigo-500 dark:text-indigo-400"></i> Connect to Friend
            </h2>
            <input type="text" id="peer-id-input" placeholder="Enter friendâ€™s ID" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 mb-4">
            <div class="flex justify-end space-x-2">
                <button onclick="closeModal()" class="p-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                    <i class="fas fa-times"></i>
                </button>
                <button onclick="connectToPeer()" class="p-2 text-white bg-indigo-500 rounded-lg hover:bg-indigo-600">
                    <i class=" StandardizedAction:connect"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        let peer;
        let connections = {};
        let currentPeer = null;

        // Initialize PeerJS
        function initializePeer() {
            peer = new Peer();
            peer.on('open', (id) => {
                document.getElementById('peer-id-display').textContent = 'ID Generated';
                document.getElementById('copy-peer-id').setAttribute('data-id', id);
                document.getElementById('connection-status').textContent = 'Connected to Server';
            });

            peer.on('connection', (conn) => {
                addConnection(conn);
                conn.on('data', (data) => {
                    displayMessage(data, conn.peer, 'peer');
                });
                conn.on('close', () => {
                    updateConnectionStatus(conn.peer, 'Disconnected');
                    removePeerFromList(conn.peer);
                });
            });

            peer.on('error', (err) => {
                console.error('PeerJS Error:', err);
                document.getElementById('peer-id-display').textContent = 'Error generating ID';
                document.getElementById('connection-status').textContent = 'Disconnected';
            });
        }

        // Add a new connection
        function addConnection(conn) {
            connections[conn.peer] = conn;
            addPeerToList(conn.peer);
            if (!currentPeer) selectPeer(conn.peer);
        }

        // Add peer to the sidebar list
        function addPeerToList(peerId) {
            const peerList = document.getElementById('peer-list');
            const peerItem = document.createElement('div');
            peerItem.className = 'p-4 flex items-center space-x-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors';
            peerItem.id = `peer-${peerId}`;
            peerItem.innerHTML = `
                <i class="fas fa-user-circle text-indigo-500 dark:text-indigo-400 text-2xl"></i>
                <div>
                    <div class="font-semibold">${peerId.slice(0, 10)}...</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400" id="status-${peerId}">Connected</div>
                </div>
            `;
            peerItem.onclick = () => selectPeer(peerId);
            peerList.appendChild(peerItem);
        }

        // Remove peer from list
        function removePeerFromList(peerId) {
            const peerItem = document.getElementById(`peer-${peerId}`);
            if (peerItem) peerItem.remove();
            if (currentPeer === peerId) {
                currentPeer = null;
                document.getElementById('current-peer').textContent = 'No peer selected';
                document.getElementById('connection-status').textContent = 'Disconnected';
                document.getElementById('chat-box').innerHTML = '';
            }
        }

        // Select a peer to chat with
        function selectPeer(peerId) {
            currentPeer = peerId;
            document.getElementById('current-peer').textContent = peerId.slice(0, 10) + '...';
            document.getElementById('connection-status').textContent = connections[peerId].open ? 'Connected' : 'Disconnected';
            document.getElementById('chat-box').innerHTML = '';
            document.getElementById('sidebar').classList.remove('active');
        }

        // Update connection status
        function updateConnectionStatus(peerId, status) {
            const statusElement = document.getElementById(`status-${peerId}`);
            if (statusElement) statusElement.textContent = status;
            if (currentPeer === peerId) document.getElementById('connection-status').textContent = status;
        }

        // Open connect modal
        function openModal() {
            document.getElementById('connect-modal').classList.remove('hidden');
        }

        // Close connect modal
        function closeModal() {
            document.getElementById('connect-modal').classList.add('hidden');
        }

        // Connect to a peer
        function connectToPeer() {
            const peerId = document.getElementById('peer-id-input').value.trim();
            if (peerId && peer && !connections[peerId]) {
                const conn = peer.connect(peerId);
                conn.on('open', () => {
                    addConnection(conn);
                    closeModal();
                });
                conn.on('data', (data) => {
                    displayMessage(data, peerId, 'peer');
                });
                conn.on('close', () => {
                    updateConnectionStatus(peerId, 'Disconnected');
                    removePeerFromList(peerId);
                });
            }
        }

        // Send a message
        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            if (message && currentPeer && connections[currentPeer] && connections[currentPeer].open) {
                connections[currentPeer].send(message);
                displayMessage(message, currentPeer, 'self');
                messageInput.value = '';
            }
        }

        // Display a message in the chat box
        function displayMessage(message, peerId, sender) {
            if (peerId !== currentPeer) return;
            const chatBox = document.getElementById('chat-box');
            const messageDiv = document.createElement('div');
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            messageDiv.className = `chat-bubble p-3 m-2 rounded-2xl shadow ${sender === 'self' ? 'bg-gradient-to-r from-indigo-100 to-blue-100 ml-auto' : 'bg-white dark:bg-gray-700 mr-auto'}`;
            messageDiv.innerHTML = `
                <div>${message}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1 text-right">${time}</div>
            `;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Copy peer ID to clipboard
        function copyPeerId() {
            const peerId = document.getElementById('copy-peer-id').getAttribute('data-id');
            navigator.clipboard.writeText(peerId).then(() => {
                alert('ID copied to clipboard!');
            });
        }

        // Toggle sidebar on mobile
        document.getElementById('toggle-sidebar').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('active');
        });

        // Toggle theme
        document.getElementById('toggle-theme').addEventListener('click', () => {
            document.body.classList.toggle('dark');
            const icon = document.getElementById('toggle-theme').querySelector('i');
            icon.classList.toggle('fa-moon');
            icon.classList.toggle('fa-sun');
        });

        // Initialize peer on page load
        window.onload = initializePeer;
    </script>
</body>
</html>
